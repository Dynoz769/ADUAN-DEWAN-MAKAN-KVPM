<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Aduan Dewan Makan - Portal Korporat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Firebase (Realtime Database) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <nav class="top-nav">
      <div class="brand">Sistem Aduan Dewan Makan</div>
      <div class="nav-buttons">
        <button type="button" data-target="home" onclick="showSection('home')">Halaman Utama</button>
        <button type="button" data-target="pelajar" onclick="showSection('pelajar')">Borang Pelajar</button>
        <button type="button" data-target="senarai" onclick="showSection('senarai')">Senarai Aduan</button>
        <button type="button" data-target="admin" onclick="showSection('admin')">Panel Admin</button>
        <button type="button" data-target="menu" onclick="showSection('menu')">Menu Makan Asrama</button>
      </div>
    </nav>

    <header class="hero-card card">
      <div>
        <div class="eyebrow">Portal Korporat</div>
        <h1>Panel Aduan & Pemantauan</h1>
        <div class="badge-live">LIVE</div>
        <p class="small">Automasi aduan pelajar, status tindakan, dan analitik rating dalam satu paparan.</p>
        <div class="hero-progress">
          <div class="small" style="margin-bottom:4px;">Purata Rating</div>
          <div class="progress-track"><div class="progress-fill" id="avgBarFill"></div></div>
        </div>
      </div>
      <div class="hero-meta">
        <div class="metric">
          <span class="label">Purata Rating</span>
          <strong id="headerAvg">-</strong>
        </div>
        <div class="metric">
          <span class="label">Jumlah Aduan</span>
          <strong id="headerTotal">0</strong>
        </div>
        <div class="metric">
          <span class="label">Peranan Admin</span>
          <strong id="headerRole">-</strong>
        </div>
      </div>
    </header>

    <section id="home" class="card">
      <h2>Halaman Utama | Sila Login</h2>
      <div class="home-grid">
        <div class="home-action">
          <h3>Login Pelajar / Admin</h3>
          <p class="small">Pilih peranan, masukkan IC/username & kata laluan.</p>
          <div class="segmented" id="roleToggle">
            <label data-role="pelajar" class="active"><input type="radio" name="login_role" value="pelajar" checked> Pelajar</label>
            <label data-role="admin"><input type="radio" name="login_role" value="admin"> Admin</label>
          </div>
          <form id="unifiedLogin">
            <label id="identifierLabel">No Kad Pengenalan
              <input type="text" id="login_identifier" required>
            </label>
            <label id="passwordLabel">Kata Laluan
              <input type="password" id="login_password" required>
            </label>
            <button type="submit" class="btn-primary">Log Masuk</button>
          </form>
          <div id="loginMsg" class="small" style="margin-top:8px"></div>
          <div class="small">Pelajar: kata laluan <strong>12345</strong>. Admin/Jaksa/Ketua Dorm/Warden/Pengurusan: username (cth: <strong>admin</strong>/<strong>jaksa</strong>/<strong>ketua dorm</strong>/<strong>warden</strong>/<strong>pihak pengurusan asrama</strong>) & kata laluan <strong>12345</strong>.</div>
        </div>

        <div class="home-action">
          <h3>Menu Makan Asrama</h3>
          <p class="small">Lihat jadual menu.</p>
          <button type="button" onclick="showSection('menu')" class="btn-ghost">Lihat Menu</button>
        </div>

        <div class="home-action" id="firstTimeCard">
          <h3>Daftar Pelajar Kali Pertama</h3>
          <p class="small">Daftarkan pelajar baharu supaya boleh login dengan IC & kata laluan.</p>
          <form id="firstTimeForm">
            <label>Nama Pelajar
              <input type="text" id="firstTime_name" placeholder="Nama penuh" required>
            </label>
            <label>No Kad Pengenalan
              <input type="text" id="firstTime_ic" required>
            </label>
            <label>Dorm
              <input type="text" id="firstTime_dorm">
            </label>
            <label>Kata Laluan
              <input type="text" id="firstTime_pass" value="12345" readonly>
            </label>
            <button type="submit" class="btn-primary">Simpan Pendaftaran</button>
          </form>
          <div id="firstTimeMsg" class="small" style="margin-top:6px;"></div>
          <div id="firstTimeList" class="small" style="margin-top:10px;">Tiada pendaftaran baharu.</div>
        </div>

      </div>
    </section>

    <section id="pelajar" class="card" style="display:none;">
      <h2>Hantar Aduan (Pelajar)</h2>
      <p class="small">Anda mesti log masuk sebagai pelajar dahulu.</p>

      <form id="complaintForm">
        <label>Nama
          <input type="text" id="name" placeholder="Nama akan terisi selepas login" disabled>
        </label>
        <label>No Kad Pengenalan (terbaca sahaja)
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="text" id="ic_display" disabled>
            <button type="button" class="btn-ghost small" onclick="copyIC()">Salin IC</button>
          </div>
        </label>
        <label>Dorm
          <input type="text" id="dorm" placeholder="Contoh: D1">
        </label>
        <label>Waktu Makan
          <select id="meal_type" required>
            <option value="Sarapan">Sarapan</option>
            <option value="Makan Tengahari">Makan Tengahari</option>
            <option value="Kudapan Petang">Kudapan Petang</option>
            <option value="Makan Malam">Makan Malam</option>
            <option value="Kudapan Malam">Kudapan Malam</option>
          </select>
        </label>
        <label>Rating (1-5)
          <input type="number" id="rating" min="1" max="5" value="3" required>
        </label>
        <div id="ratingDesc" class="small" style="margin-top:-4px;"></div>
        <label>Aduan / Cadangan
          <textarea id="message" rows="3"></textarea>
        </label>
        <label>Upload Gambar Aduan (optional)
          <input type="file" id="image" accept="image/*">
        </label>
        <button type="submit" class="btn-primary">Hantar Aduan</button>
        <button type="button" onclick="studentLogout()" class="btn-ghost" style="margin-left:8px;">Logout Pelajar</button>
        <div id="statusMsg" class="small" style="margin-top:8px"></div>
      </form>
    </section>

    <section id="senarai" class="card" style="display:none;">
      <h2>Senarai Aduan (Pelajar)</h2>
      <p class="small">Anda mesti log masuk sebagai pelajar dahulu.</p>

      <div class="card" style="padding:12px 14px; margin-bottom:14px;">
        <div class="eyebrow">Penapis Aduan Pelajar</div>
        <div class="filter-row">
          <input type="text" id="studentSearch" placeholder="Cari nama / dorm / aduan" style="max-width:220px;">
          <select id="studentStatusFilter" style="max-width:160px;">
            <option value="ALL">Status: Semua</option>
            <option value="Baru">Baru</option>
            <option value="DalamProses">DalamProses</option>
            <option value="Selesai">Selesai</option>
          </select>
          <select id="studentRatingFilter" style="max-width:160px;">
            <option value="ALL">Rating: Semua</option>
            <option value="4plus">Rating 4 & 5</option>
            <option value="low">Rating 1 & 2</option>
            <option value="exact5">Rating 5 sahaja</option>
          </select>
          <select id="studentSort" style="max-width:180px;">
            <option value="latest">Terbaru</option>
            <option value="oldest">Terdahulu</option>
            <option value="high">Rating tertinggi</option>
            <option value="low">Rating terendah</option>
          </select>
          <select id="studentMealFilter" style="max-width:170px;">
            <option value="ALL">Waktu: Semua</option>
            <option value="Sarapan">Sarapan</option>
            <option value="Makan Tengahari">Makan Tengahari</option>
            <option value="Kudapan Petang">Kudapan Petang</option>
            <option value="Makan Malam">Makan Malam</option>
            <option value="Kudapan Malam">Kudapan Malam</option>
          </select>
          <label style="display:flex; align-items:center; gap:6px; font-size:13px;">
            <input type="checkbox" id="studentMineOnly"> Aduan saya sahaja
          </label>
          <button type="button" class="btn-ghost small" onclick="resetStudentFilters()">Reset</button>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;" id="studentStats">
          <span class="stat-chip">Jumlah: <span id="studentTotal">0</span></span>
          <span class="stat-chip"><span class="dot baru"></span> Baru: <span id="studentCountBaru">0</span></span>
          <span class="stat-chip"><span class="dot proses"></span> Proses: <span id="studentCountProses">0</span></span>
          <span class="stat-chip"><span class="dot selesai"></span> Selesai: <span id="studentCountSelesai">0</span></span>
        </div>
      </div>

      <h3>Senarai Aduan Terkini</h3>
      <div id="complaintsList">Tiada aduan lagi.</div>
    </section>

    <section id="admin" class="card" style="display:none;">
      <h2>Panel Admin</h2>

      <div id="adminControls" style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <button type="button" onclick="showSection('home')" class="btn-ghost">Kembali ke Halaman Utama</button>
        <button type="button" onclick="adminLogout()" class="btn-ghost">Logout Admin</button>
        <select id="adminActionSelect" class="btn-ghost" onchange="handleAdminAction(this.value)" style="min-width:220px; padding:10px 12px; border-radius:12px;">
          <option value="">Pilih tindakan pantas</option>
          <option value="export_csv">Eksport CSV</option>
          <option value="export_json">Eksport JSON</option>
          <option value="export_pdf">Eksport PDF</option>
          <option value="seed_demo">Tambah 30 Hari Data Demo</option>
          <option value="bulk_process">Tandai semua Baru → DalamProses</option>
          <option value="bulk_delete">Padam semua Selesai</option>
        </select>
      </div>

      <div class="card" style="padding:12px 14px; margin-bottom:14px;">
        <div class="eyebrow admin-highlight">Import Senarai Pelajar (Nama, MyKad, Dorm)</div>
        <p class="small">Tampal data berbaris: <code>Nama;MyKad;Dorm</code>. Contoh: <code>ALI BIN ABU;050825-03-0663;2A1</code>. Dorm akan terisi automatik bila pelajar login.</p>
        <div class="flex-col">
          <textarea id="studentImport" rows="4" placeholder="Nama;MyKad;Dorm"></textarea>
          <button type="button" class="btn-primary small" onclick="importStudents()">Import Pelajar</button>
          <div id="studentImportMsg" class="small"></div>
        </div>
      </div>
      <div class="card" style="padding:12px 14px; margin-bottom:14px;">
        <div class="eyebrow admin-highlight">Senarai Pelajar Daftar Kali Pertama</div>
        <div class="filter-row" style="margin-bottom:8px;">
          <input type="text" id="firstTimeAdminSearch" placeholder="Cari nama / IC" style="max-width:220px;">
        </div>
        <div id="firstTimeAdminList" class="small">Tiada pendaftaran baharu.</div>
        <div class="filter-row" style="margin-top:10px;">
          <button type="button" class="btn-ghost small" onclick="clearCustomStudents()">Clear All</button>
        </div>
      </div>

      <div class="status-row" id="statusCounts">
        <div class="status-card">
          <div class="label">Baru</div>
          <div class="value" id="countBaru">0</div>
        </div>
        <div class="status-card">
          <div class="label">Dalam Proses</div>
          <div class="value" id="countDalamProses">0</div>
        </div>
        <div class="status-card">
          <div class="label">Selesai</div>
          <div class="value" id="countSelesai">0</div>
        </div>
      </div>

      <div class="legend">
        <span class="chip"><span class="dot baru"></span>Aduan Baru</span>
        <span class="chip"><span class="dot proses"></span>Tindakan Sedang Diproses</span>
        <span class="chip"><span class="dot selesai"></span>Selesai & Boleh Ditutup</span>
      </div>

      <div class="card" style="padding:12px 14px; margin-bottom:14px;">
        <div class="eyebrow">Penapis Pantas</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input type="text" id="adminSearch" placeholder="Cari nama / IC / dorm / aduan" style="max-width:220px;">
          <select id="adminStatusFilter" style="max-width:160px;">
            <option value="ALL">Status: Semua</option>
            <option value="Baru">Baru</option>
            <option value="DalamProses">DalamProses</option>
            <option value="Selesai">Selesai</option>
          </select>
          <select id="adminRatingFilter" style="max-width:160px;">
            <option value="ALL">Rating: Semua</option>
            <option value="4plus">Rating 4 & 5</option>
            <option value="low">Rating 1 & 2</option>
            <option value="exact5">Rating 5 sahaja</option>
          </select>
          <select id="adminSort" style="max-width:180px;">
            <option value="latest">Terbaru</option>
            <option value="oldest">Terdahulu</option>
            <option value="high">Rating tertinggi</option>
            <option value="low">Rating terendah</option>
          </select>
          <select id="adminMealFilter" style="max-width:170px;">
            <option value="ALL">Waktu: Semua</option>
            <option value="Sarapan">Sarapan</option>
            <option value="Makan Tengahari">Makan Tengahari</option>
            <option value="Kudapan Petang">Kudapan Petang</option>
            <option value="Makan Malam">Makan Malam</option>
            <option value="Kudapan Malam">Kudapan Malam</option>
          </select>
          <button type="button" class="btn-ghost small" onclick="resetAdminFilters()">Reset</button>
        </div>
      </div>

      <div class="status-progress">
        <div class="progress-block">
          <div class="progress-label"><span>Baru</span><span id="percBaru">0%</span></div>
          <div class="progress-rail"><div class="progress-bar baru" id="progressBaru"></div></div>
        </div>
        <div class="progress-block">
          <div class="progress-label"><span>Dalam Proses</span><span id="percDalamProses">0%</span></div>
          <div class="progress-rail"><div class="progress-bar proses" id="progressDalamProses"></div></div>
        </div>
        <div class="progress-block">
          <div class="progress-label"><span>Selesai</span><span id="percSelesai">0%</span></div>
          <div class="progress-rail"><div class="progress-bar selesai" id="progressSelesai"></div></div>
        </div>
      </div>

      <div class="card" style="padding:12px 14px; margin-bottom:14px;">
        <div class="eyebrow">Urus Menu Makanan & Minuman</div>
        <div class="menu-admin">
          <div>
            <label>Minggu
              <select id="weeklyMenuWeek">
                <option value="1">Minggu 1</option>
                <option value="2">Minggu 2</option>
                <option value="3">Minggu 3</option>
                <option value="4">Minggu 4</option>
                <option value="5">Minggu 5</option>
                <option value="6">Minggu 6</option>
                <option value="7">Minggu 7</option>
                <option value="8">Minggu 8</option>
                <option value="9">Minggu 9</option>
                <option value="10">Minggu 10</option>
                <option value="11">Minggu 11</option>
                <option value="12">Minggu 12</option>
                <option value="13">Minggu 13</option>
                <option value="14">Minggu 14</option>
                <option value="15">Minggu 15</option>
                <option value="16">Minggu 16</option>
              </select>
            </label>
          </div>
          <div>
            <label>Hari
              <select id="weeklyMenuDay">
                <option value="Ahad">Ahad</option>
                <option value="Isnin">Isnin</option>
                <option value="Selasa">Selasa</option>
                <option value="Rabu">Rabu</option>
                <option value="Khamis">Khamis</option>
                <option value="Jumaat">Jumaat</option>
                <option value="Sabtu">Sabtu</option>
              </select>
            </label>
          </div>
          <div>
            <label>Waktu
              <select id="weeklyMenuSlot">
                <option value="Sarapan">Sarapan</option>
                <option value="Tengahari">Makan Tengahari</option>
                <option value="Petang">Kudapan Petang</option>
                <option value="Malam">Makan Malam</option>
                <option value="MinumMalam">Kudapan Malam</option>
              </select>
            </label>
          </div>
          <div class="full">
            <label>Menu (makanan/minuman)
              <input type="text" id="weeklyMenuItemName" placeholder="Contoh: Nasi Lemak + Teh O">
            </label>
          </div>
          <div class="inline-btns full">
            <button type="button" class="btn-primary small admin-highlight-btn" onclick="addWeeklyMenuItem()">Tambah Menu</button>
            <button type="button" class="btn-ghost small" onclick="resetWeeklyMenuForm()">Reset</button>
            <span id="weeklyMenuMsg" class="small"></span>
          </div>
        </div>
        <div id="weeklyMenuAdminList" class="small" style="margin-top:8px;"></div>
      </div>

      <div id="adminList">Tiada aduan.</div>

      <div class="admin-analytics">
        <h3>Analisis Rating</h3>
        <div class="avg-box small">
          Purata Rating: <span id="avgRating">-</span> / 5
        </div>

        <div class="chart-row">
          <div class="chart-card">
            <h4>Peratusan Mengikut Rating (Pai)</h4>
            <canvas id="ratingPie" aria-label="chart-pie" role="img"></canvas>
          </div>
      <div class="chart-card">
        <h4>Jumlah Aduan Mengikut Rating (Pai)</h4>
        <canvas id="ratingBar" aria-label="chart-pie" role="img"></canvas>
      </div>
    </div>
  </div>
</section>

<div id="imageModal" class="image-modal" onclick="closeImageViewer(event)">
  <button class="close-btn" aria-label="Tutup" onclick="closeImageViewer(event)">×</button>
  <img id="modalImage" alt="Lampiran aduan">
</div>

    <section id="menu" class="card" style="display:none;">
      <h2>Menu Makan Asrama</h2>
      <div class="card" style="margin-top:16px;">
        <div class="eyebrow">Jadual Menu 16 Minggu</div>
        <div id="weeklyMenuList"></div>
      </div>
    </section>

  </div>

<script src="app.js"></script>
</body>
</html>





